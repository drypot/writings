# Tomcat Connection Performance Comparison

2010-11-29 16:00

톰켓이 여러 컨넥터 구현 방식과 프로토콜을 사용하고
아파치 또한 몇 가지 방식 구현이 있기 때문에 각 조합에 있어 속도가 얼마나 나오나 항상들 궁금하셨을 겁니다.
톰켓 동물책에 보면 벤치마크 결과가 나와있습니다.
내용을 간추려 소개합니다.

아파치나 톰켓을 독립으로 운영했을 때 속도가
아파치 + 톰켓 조합으로 톰켓에서 일단 파일 읽고 아파치 통해서 보내는 방식보다
2 배에서 3 배 가까이 빠릅니다.
하지만 현업에서는 왠만한 경우 이렇게 쓸 수 없습니다.
한 기계에서 톰켓 인스턴스 하나만 운영한다면 가능하겠지만
톰켓의 다중 사이트 관리 능력이 너무나 후져서
다른 톰켓 인스턴스 추가되는 순간부터 앞에 뭐가 있어야합니다.

스터틱 파일 서비스 능력만 보면 톰켓의 아파치에 비해서 전혀 뒤지지 않습니다.
고로 속도를 위해서 아파치 쓴다는 통념은 잘못되었다는 것을 알 수 있습니다.
자바도 NIO 등장하면서 파일에서 소켓으로 커널층에서 바로 데이터를 쏠 수 있습니다.

로직과 더불어 극한의 속도가 필요하면 서버 한 대에 톰켓 인스턴스 하나만 딱 돌리고,
앞에 아파치 같은 것 없이 톰켓을 정면에서 서비스하는 것이 좋습니다. (또는 그래야만 합니다)

아파치를 톰켓 앞에 세웠을 경우 아파치와 톰켓은 HTTP 나 AJP 프로토콜로 통신하게 됩니다.
HTTP 는 텍스트 형식 데이터가 왔다갔다하고 AJP 는 바이너리가 왔다갔다 합니다.
당연히 AJP 가 더 빠를 것이라 예상할 수 있는데
그래프에 따르면 그렇게 확 차이나는 것은 아닙니다. 최대한 10% 정도?

아파치 단의 AJP 구현은 두가지 방식이 있습니다.
mod_jk 라고 별도의 모듈을 쓰던 옛날 방식과 mod_proxy 에 아예 AJP 구현이 추가된 요즘 방식.
당연 요즘 mod_proxy 쓰는 것이 다 빠르군요.

문제는 AJP 프로토콜이 좀 지저분하고 (만들다가 사람들이 사라지고, 다른 사람이 만들고 막 이랬음)
아파치 외에 nginx 나 기타 웹 서버에서는 전혀 지원하지 않는다는 겁니다.
그러니 특별히 AJP 에 애착이 없다면 일단 AJP 사용은 접어 둡시다.

프런트 서버와 톰켓을 함께 쓰고 HTTP 로 통신한다고 가정하고 계속 이어갑니다.

톰켓은 컨넥터 구현에 3 가지 방식을 씁니다.
하나는 구 java.io (JIO) 라이브러리,
또 하나는 Non-blocking IO (NIO) 라이브러리,
또 하나는 아파치에서 쓰는 C 라이브러리를 JNI 로 래핑해서 쓰는 APR,

NIO 는 커널 버퍼를 바로 억세스 한다는 특징 + Non-Blocking 서버 구현이 가능하다는 특징이 있습니다.

APR 은 톰켓 bin 디렉토리에 들어있는 C 라이브러리 풀고 커파일해야 사용가능합니다. 귀찮죠.
게다가 그래프에 나와있다 시피 저거 쓴다고 빨라지지도 않습니다 요즘은. =,=
그러니 그냥 무시합시다.

그럼 JIO 하고 NIO 하고 남는데, 이것 중 선택하려면 Non-blocking 설명이 좀 필요합니다.
그래프 상으로는 JIO 가 더 빠르게 나오는데, 실제 서비스에서는 그렇지 않을 확률이 높기 때문에.

Java 에서 NIO 라는 단어를 쓰는데 사실 여기에는 이 Non-Blocking IO 외에도 커널 버퍼에 직접접속이란 특징이 있습니다.
파일 크기가 100 킬로 넘어가면서 부터는 NIO 가 더 빨라진다는 보고도 많습니다.
그리고, 파일이 많아져서 케슁하기 어려운 상황이 되면 NIO 가 훨씬 더 빨라질겁니다.
NIO 는 자바 JVM 으로 데이터를 가져오지 않고도 커널 상의 이쪽 버퍼에서 저쪽 버퍼로 데이터를 이동시키는 API 들이 있습니다.

그래서, 요약하면, 프런트와 톰켓이 통신할 때는 HTTP 써도 큰 문제 없고 더 편리하다.
톰켓에 IO 방식이 3 가지 있는데 NIO 를 쓰면 된다.
속도가 많이 필요하면 앞단 거둬내고 톰켓을 바로써야한다.
기계 두 대로 늘리는 것보다 앞단 거둬내는 것이 효과가 더 좋다.
